---
layout: post
title:  自动化安装之PXE
date:   2017-09-18 08:00:00
categories: Linux 
tags:  PXE 自动化安装 DHCP
---

## 介绍

> &emsp;&emsp; PXE(preboot execute environment，预启动执行环境)是由Intel公司开发的最新技术，工作于Client/Server的网络模式，支持工作站通过网络从远端服务器下载映像，
> 并由此支持通过网络启动操作系统，在启动过程中，终端要求服务器分配IP地址，再用TFTP(trivial file transfer protocol)或MTFTP(multicast trivial file transfer protocol)协议下载一个启动软件包到本机内存中执行，
> 由这个启动软件包完成终端(客户)基本软件设置，从而引导预先安装在服务器中的终端操作系统。
> PXE可以引导多种操作系统，如Windows95/windows2000/win7/win8/及linux等。

> 接下来我们将会对PXE自动安装程序进行详细的介绍

### 网络PXE自动化安装CentOS 6

> 本文进行了最初的设定：

名称| 作用
:---:| :---:
centos 6.9| DHCP服务器
centos 6.9 mini| 客户端

#### 1、安装包并启动服务

> 在PXE安装时需要安装以下安装包

```shell

相关安装包
vsftpd tftp-server dhcp syslinux-nonlinux

chkconfig dhcpd on    #dhcp等到配置完成后才能够启动，这里先设定为开机自启
chkconfig tftp on
service xinetd restart
chkconfig vsftpd on
service vsftpd start
ss -nutlp

```

#### 2、准备yum源

> 这里我们通过ftp来设定为yum源，本文设定通过本机来作为ftp的yum，步骤如下：

```

#将光盘挂载在ftp的设定目录下
mkdir /var/ftp/pub/centos/6 -pv
mount /dev/sr0 /var/ftp/pub/centos/6

```


> 我们需要自己设定kickstart文件，对光盘中的anaconda.cfg进行修改就可进行使用
> 这里我们进行自己的设定
> 命令如下:

```

#将光盘下的anaconda-ks.cfg文件复制并修改
cp /root/anaconda-ks.cfg /var/ftp/pub/ksdir/ks6.cfg  
vim /var/ftp/pub/ksdir/ks6.cfg 

```
> anaconda-ks.cfg文件设定为：

```

# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
url --url=ftp://172.18.18.18/centos/6                                   #配置自己yum源
text									#设定为文本格式
lang en_US.UTF-8
keyboard us
network --onboot yes --device eth0 --bootproto dhcp --noipv6
rootpw  --iscrypted $6$mNuH51W2tp8jiHxI$WAp.MD0HTIGp8EbsLDwt6ywdEOpzc0VbDhZU1SEf80FXDKdF
yO8LZPX5eBoedhXFsiUcEDz/4j1dPoxL/sxGu1
firewall --service=ssh
authconfig --enableshadow --passalgo=sha512
selinux --enforcing
timezone Asia/Shanghai
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --all							        #清除分区表
zerombr									#清空mbr
part /boot --fstype=ext4 --size=1024
part / --fstype=ext4 --size=50000
part /app --fstype=ext4 --size=40000

part swap --size=2048

repo --name="CentOS"  --baseurl=cdrom:sr0 --cost=100

%packages
@base
...
部分省略
...
xorg-x11-xdm
libXmu
rdesktop
%end

```

> 这里只对部分进行标注，设定好ks.cfg文件后我们需要对修改后的文件进行检查，文件是否更改正确

> 进行检查的命令包为：system-config-kickstart ，进行yum安装即可

```shell
ksvalidator  /var/ftp/pub/ksdir/ks6.cfg
```

**注意:从光盘复制过来的文件只对root(管理员)可读，我们需要将其权限更改为都可读，执行命令chmod +r /var/ftp/pub/ksdir/ks6.cfg完成权限更改**

#### 3、配置DHCP服务

> 


> 我们先来看一下，dhcp的包内相关文件

```shell

[root@Centos6 ~]#rpm -ql dhcp

/etc/dhcp
/etc/dhcp/dhcpd.conf				#dhcp配置文件
/etc/dhcp/dhcpd6.conf
/etc/openldap/schema/dhcp.schema
/etc/portreserve/dhcpd
/etc/rc.d/init.d/dhcpd				#dhcpd服务
/etc/rc.d/init.d/dhcpd6				#ipv6dhcpd服务
/etc/rc.d/init.d/dhcrelay
/etc/rc.d/init.d/dhcrelay6
/etc/sysconfig/dhcpd				#dhcpd参数设置
/etc/sysconfig/dhcpd6
/etc/sysconfig/dhcrelay				#dhcp中继器(通过命令可开启)
/etc/sysconfig/dhcrelay6
/usr/bin/omshell
/usr/sbin/dhcpd					#dhcp二进制程序
/usr/sbin/dhcrelay
/usr/share/doc/dhcp-4.1.1
...
部分省略
...
/var/lib/dhcpd
/var/lib/dhcpd/dhcpd.leases			#dhcp的服务获取地址列表信息
/var/lib/dhcpd/dhcpd6.leases

```

> 我们在打开dhcp.conf 文件时提示可以参照/usr/share/doc/dhcp*/dhcpd.conf.example文件，所以我们将示例文件移动覆盖dhcp.conf即可
> 同时我们一并将对文件进行修改

```

[root@Centos6 ~]#vim /etc/dhcp/dhcpd.conf

# dhcpd.conf
#
# Sample configuration file for ISC dhcpd
#

# option definitions common to all supported networks...
option domain-name "example.org";						#主机名
option domain-name-servers ns1.example.org, ns2.example.org;			#DNS名

default-lease-time 600;								#默认租期时间
max-lease-time 7200;								#最大租期时间

# Use this to enble / disable dynamic dns updates globally.
#ddns-update-style none;

# If this DHCP server is the official DHCP server for the local
# network, the authoritative directive should be uncommented.
#authoritative;

# Use this to send dhcp log messages to a different log file (you also
# have to hack syslog.conf to complete the redirection).
log-facility local7;

# No service will be given on this subnet, but declaring it helps the 
# DHCP server to understand the network topology.

subnet 172.18.18.0 netmask 255.255.255.0 {					#子网地址及掩码
        range 172.18.18.20 172.18.18.30;					#dhcp地址池范围
        next-server 172.18.18.18;						#提供引导文件的服务器IP地址
        filename "pxelinux.0";							#引导文件的位置
}

以下省略
...

```

> 将dhcp服务启动，service dhcpd restart

> 到此我们来查看一下相关的服务是否都已经开启

```shell

[root@Centos6 ~]#netstat -ntulp

Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name   
tcp        0      0 0.0.0.0:111                 0.0.0.0:*                   LISTEN      1637/rpcbind        
tcp        0      0 0.0.0.0:21                  0.0.0.0:*                   LISTEN      4997/vsftpd         #ftp服务已开启
...
部分省略
...
udp        0      0 0.0.0.0:67                  0.0.0.0:*                               5068/dhcpd          #dhcp服务已开启
udp        0      0 0.0.0.0:964                 0.0.0.0:*                               1637/rpcbind        
udp        0      0 0.0.0.0:69                  0.0.0.0:*                               4929/xinetd         #tftp服务已开启
udp        0      0 0.0.0.0:111                 0.0.0.0:*                               1637/rpcbind        
udp        0      0 0.0.0.0:631                 0.0.0.0:*                               1788/cupsd          
udp        0      0 0.0.0.0:33807               0.0.0.0:*                               1743/rpc.statd      
udp        0      0 127.0.0.1:659               0.0.0.0:*                               1743/rpc.statd      
udp        0      0 :::964                      :::*                                    1637/rpcbind        
udp        0      0 :::111                      :::*                                    1637/rpcbind        
udp        0      0 :::58631                    :::*                                    1743/rpc.statd     

```


#### 4、准备PXE相关文件

> 

> tftp默认的共享路径: /var/lib/tftpboot/
> 我们需要将引导文件pxelinux.0、内核文件vmlinuz、虚拟文件系统文件initrd.img、以及启动菜单模式文件menu.c32，放置在tftp的共享目录下

```

#将需要的文件复制到tftp对应的共享目录

cp /usr/share/syslinux/{pxelinux.0,menu.c32} /var/lib/tftpboot/
cp /misc/cd/images/pxeboot/{initrd.img,vmlinuz} /var/lib/tftpboot/

```

> 制作启动菜单
> 先创建好启动菜单的目录，及名称

```

#启动菜单需要放到/var/lib/tftpboot/pxelinux.cfg/下并且需要命名成default

mkdir pxelinux.cfg
cp /misc/cd/isolinux/isolinux.cfg  /var/lib/tftpboot/pxelinux.cfg/default

#查看tftp的/var/lib/tftpboot/目录

[root@Centos6 /var/lib/tftpboot]#tree

.
├── initrd.img
├── menu.c32
├── pxelinux.0
├── pxelinux.cfg
│   └── default
└── vmlinuz

1 directory, 5 files

```
> 设定启动菜单文件

```shell

[root@Centos6 ~]#vim /var/lib/tftpboot/pxelinux.cfg/default

default menu.c32
#prompt 1
timeout 600

menu title Welcome to CentOS 6.9!

label desktop
  menu label auto Install a ^desktop system
  kernel vmlinuz
  append initrd=initrd.img ks=ftp://172.18.18.18/pub/ksdir/ks6.cfg
label manual
  menu label Install ^manual system
  kernel vmlinuz
  append initrd=initrd.img rescue inst.repo=ftp://172.18.18.18/pub/centos/6
label local
  menu default
  menu label Boot from ^local drive
  localboot 0xffff
menu end


```

> 在centos 6.9mini的机器上开机选择网络安装即可，会自行通过DHCP服务器获取IP地址

> 启动菜单界面如下: 

![启动界面图片](https://thumbnail0.baidupcs.com/thumbnail/ea699baba6bc8d4762799176e3c18da7?fid=2905626949-250528-674640850583317&time=1505692800&rt=sh&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-intgG%2F8wds7zQr%2FjV9L9pLn0A4c%3D&expires=8h&chkv=0&chkbd=0&chkpc=&dp-logid=6038480158274032413&dp-callid=0&size=c710_u400&quality=100&vuk=-&ft=video)

